package staking

import (
	"fmt"
	"math/big"

	"tynmo/chain"
	"tynmo/helper/common"
	"tynmo/helper/hex"
	"tynmo/helper/keccak"
	"tynmo/types"
	"tynmo/validators"
)

var (
	BaseReward   = uint64(0x100000000)
	RewardWallet = types.StringToAddress("0xffffFFFfFFffffffffffffffFfFFFfffFFFfFFfE")
	Owner        = types.StringToAddress("0xffffFFFfFFffffffffffffffFfFFFfffFFFfFFfE")
)

// getAddressMapping returns the key for the SC storage mapping (address => something)
//
// More information:
// https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html
func getAddressMapping(address types.Address, slot int64) []byte {
	bigSlot := big.NewInt(slot)

	finalSlice := append(
		common.PadLeftOrTrim(address.Bytes(), 32),
		common.PadLeftOrTrim(bigSlot.Bytes(), 32)...,
	)

	return keccak.Keccak256(nil, finalSlice)
}

// getIndexWithOffset is a helper method for adding an offset to the already found keccak hash
func getIndexWithOffset(keccakHash []byte, offset uint64) []byte {
	bigOffset := big.NewInt(int64(offset))
	bigKeccak := big.NewInt(0).SetBytes(keccakHash)

	bigKeccak.Add(bigKeccak, bigOffset)

	return bigKeccak.Bytes()
}

// getStorageIndexes is a helper function for getting the correct indexes
// of the storage slots which need to be modified during bootstrap.
//
// It is SC dependant, and based on the SC located at:
func getStorageIndexes(validator validators.Validator, index int) *StorageIndexes {
	storageIndexes := &StorageIndexes{}
	address := validator.Addr()

	// Get the indexes for the mappings
	// The index for the mapping is retrieved with:
	// keccak(address . slot)
	// . stands for concatenation (basically appending the bytes)

	storageIndexes.AddressToValidatorIndexIndex = getAddressMapping(
		address,
		addressToValidatorIndexSlot,
	)

	storageIndexes.ValidatorsMapIndex = getAddressMapping(
		address,
		validatorsMapSlot,
	)

	storageIndexes.ValidatorStakeIndex = getIndexWithOffset(
		storageIndexes.ValidatorsMapIndex,
		uint64(validatorStake),
	)

	storageIndexes.ValidatorRewardIndex = getIndexWithOffset(
		storageIndexes.ValidatorsMapIndex,
		uint64(validatorReward),
	)

	storageIndexes.ValidatorIsActiveIndex = getIndexWithOffset(
		storageIndexes.ValidatorsMapIndex,
		uint64(validatorIsActive),
	)

	storageIndexes.ValidatorIsWhitelistedIndex = getIndexWithOffset(
		storageIndexes.ValidatorsMapIndex,
		uint64(validatorIsWhitelisted),
	)

	storageIndexes.ValidatorBlsKeyIndex = getIndexWithOffset(
		storageIndexes.ValidatorsMapIndex,
		uint64(validatorBlsKey),
	)

	// Index for array types is calculated as keccak(slot) + index
	// The slot for the dynamic arrays that's put in the keccak needs to be in hex form (padded 64 chars)
	storageIndexes.ValidatorsIndex = getIndexWithOffset(
		keccak.Keccak256(nil, common.PadLeftOrTrim(big.NewInt(validatorsSlot).Bytes(), 32)),
		uint64(index),
	)

	return storageIndexes
}

// setBytesToStorage sets bytes data into storage map from specified base index
func setBytesToStorage(
	storageMap map[types.Hash]types.Hash,
	baseIndexBytes []byte,
	data []byte,
) {
	dataLen := len(data)
	baseIndex := types.BytesToHash(baseIndexBytes)

	if dataLen <= 31 {
		bytes := types.Hash{}

		copy(bytes[:len(data)], data)

		// Set 2*Size at the first byte
		bytes[len(bytes)-1] = byte(dataLen * 2)

		storageMap[baseIndex] = bytes

		return
	}

	// Set size at the base index
	baseSlot := types.Hash{}
	baseSlot[31] = byte(2*dataLen + 1)
	storageMap[baseIndex] = baseSlot

	zeroIndex := keccak.Keccak256(nil, baseIndexBytes)
	numBytesInSlot := 256 / 8

	for i := 0; i < dataLen; i++ {
		offset := i / numBytesInSlot

		slotIndex := types.BytesToHash(getIndexWithOffset(zeroIndex, uint64(offset)))
		byteIndex := i % numBytesInSlot

		slot := storageMap[slotIndex]
		slot[byteIndex] = data[i]

		storageMap[slotIndex] = slot
	}
}

// PredeployParams contains the values used to predeploy the PoS staking contract
type PredeployParams struct {
	RewardWallet types.Address
	Owner        types.Address
	// BaseReward   uint64
}

// StorageIndexes is a wrapper for different storage indexes that
// need to be modified
type StorageIndexes struct {
	ValidatorsIndex              []byte // []address
	AddressToValidatorIndexIndex []byte // mapping(address => uint256)
	ValidatorsMapIndex           []byte // mapping(address => struct)
	ValidatorStakeIndex          []byte // mapping(address => struct {uint256})
	ValidatorRewardIndex         []byte // mapping(address => struct {uint256})
	ValidatorBlsKeyIndex         []byte // mapping(address => struct {byte[]})
	ValidatorIsActiveIndex       []byte // mapping(address => struct {bool})
	ValidatorIsWhitelistedIndex  []byte // mapping(address => struct {bool})
	ValidatorDelegateeMapIndex   []byte // mapping(address => struct)
}

// Slot definitions for SC storage
var (
	validatorsSlot              = int64(0) // Slot 0
	addressToValidatorIndexSlot = int64(1) // Slot 1
	validatorsMapSlot           = int64(2) // Slot 2
	stakedAmountSlot            = int64(3) // Slot 3
	rewardWalletSlot            = int64(4) // Slot 4
	ownerSlot                   = int64(5) // Slot 5
	// validatorDelegateeMapSlot   = int64(6) // Slot 6

	validatorStake         = int64(0) // Slot 0
	validatorReward        = int64(1) // Slot 1
	validatorBlsKey        = int64(2) // Slot 2
	validatorIsActive      = int64(3) // Slot 3
	validatorIsWhitelisted = int64(4) // Slot 4
)

const (
	DefaultStakedBalance = "0x8AC7230489E80000" // 10 ETH
	//nolint: lll
	StakingSCBytecode = "0x6080604052600436106102085760003560e01c806375615a5e11610118578063b971168a116100a0578063ca1e78191161006f578063ca1e7819146106c6578063d94c111b146106f1578063dc36d3ba1461071a578063f2fde38b14610757578063fb75b2c71461078057610212565b8063b971168a1461063f578063bcc6587f14610668578063c279bf5614610672578063c885bc58146106af57610212565b80638aaab659116100e75780638aaab659146105555780638e73064f146105805780639648f471146105ab578063a580cbe3146105d4578063b6338917146105fd57610212565b806375615a5e146104cb57806379ba5097146104f75780637a6eea371461050e57806383ebf6fc1461053957610212565b8063346683f01161019b5780634a829c1c1161016a5780634a829c1c14610407578063542c85f2146104325780635958621e1461045b5780636013e70014610484578063690f30e8146104af57610212565b8063346683f01461037e578063373d6132146103a75780633a4b66f1146103d25780633c561f04146103dc57610212565b80632367f6b5116101d75780632367f6b5146102d85780632540b91a1461031557806325d5971f1461033e5780632def66201461036757610212565b806307358b991461021757806316e1310114610254578063188ce6a51461027f578063234ea0ac146102bc57610212565b3661021257600080fd5b600080fd5b34801561022357600080fd5b5061023e6004803603810190610239919061500e565b6107ab565b60405161024b919061504a565b60405180910390f35b34801561026057600080fd5b506102696107c3565b604051610276919061504a565b60405180910390f35b34801561028b57600080fd5b506102a660048036038101906102a191906150c3565b6107d0565b6040516102b3919061512e565b60405180910390f35b6102d660048036038101906102d19190615149565b6108d5565b005b3480156102e457600080fd5b506102ff60048036038101906102fa91906150c3565b610aa9565b60405161030c919061504a565b60405180910390f35b34801561032157600080fd5b5061033c60048036038101906103379190615189565b610af5565b005b34801561034a57600080fd5b506103656004803603810190610360919061500e565b610b50565b005b34801561037357600080fd5b5061037c610ba4565b005b34801561038a57600080fd5b506103a560048036038101906103a091906150c3565b610bf9565b005b3480156103b357600080fd5b506103bc610c52565b6040516103c9919061504a565b60405180910390f35b6103da610c5c565b005b3480156103e857600080fd5b506103f1610d17565b6040516103fe919061531b565b60405180910390f35b34801561041357600080fd5b5061041c610f0d565b604051610429919061504a565b60405180910390f35b34801561043e57600080fd5b50610459600480360381019061045491906153a2565b610f17565b005b34801561046757600080fd5b50610482600480360381019061047d91906150c3565b611003565b005b34801561049057600080fd5b506104996110d7565b6040516104a6919061504a565b60405180910390f35b6104c960048036038101906104c491906150c3565b6110e3565b005b3480156104d757600080fd5b506104e06111b7565b6040516104ee9291906154ad565b60405180910390f35b34801561050357600080fd5b5061050c611322565b005b34801561051a57600080fd5b506105236114be565b604051610530919061504a565b60405180910390f35b610553600480360381019061054e9190615533565b6114ca565b005b34801561056157600080fd5b5061056a611893565b604051610577919061504a565b60405180910390f35b34801561058c57600080fd5b5061059561189d565b6040516105a2919061504a565b60405180910390f35b3480156105b757600080fd5b506105d260048036038101906105cd9190615149565b6118a7565b005b3480156105e057600080fd5b506105fb60048036038101906105f691906150c3565b6119a6565b005b34801561060957600080fd5b50610624600480360381019061061f91906150c3565b6119fe565b60405161063696959493929190615612565b60405180910390f35b34801561064b57600080fd5b5061066660048036038101906106619190615149565b611ac2565b005b610670611bc1565b005b34801561067e57600080fd5b50610699600480360381019061069491906150c3565b611c7d565b6040516106a6919061575f565b60405180910390f35b3480156106bb57600080fd5b506106c4611de7565b005b3480156106d257600080fd5b506106db611e76565b6040516106e89190615781565b60405180910390f35b3480156106fd57600080fd5b50610718600480360381019061071391906158d3565b611f04565b005b34801561072657600080fd5b50610741600480360381019061073c91906150c3565b611fa5565b60405161074e9190615781565b60405180910390f35b34801561076357600080fd5b5061077e600480360381019061077991906150c3565b6120d0565b005b34801561078c57600080fd5b50610795612220565b6040516107a2919061592b565b60405180910390f35b600a6020528060005260406000206000915090505481565b6802b5e3af16b188000081565b6107d8614f7b565b816107e28161224a565b80156107f357506107f2816122ab565b5b610832576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610829906159a3565b60405180910390fd5b600c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060405180604001604052908160008201548152602001600182015481525050915050919050565b6108de3361224a565b61091d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161091490615a0f565b60405180910390fd5b60003390506000349050610931828261230c565b610970576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161096790615a7b565b60405180910390fd5b6000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055506000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001018190555083600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002018190555082600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030181905550610a9782612442565b610aa3826000836124e2565b50505050565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050919050565b8133610b018282612719565b610b40576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b3790615ae7565b60405180910390fd5b610b4a848461289c565b50505050565b610b593361224a565b610b98576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b8f90615a0f565b60405180910390fd5b610ba181612b1e565b50565b33610bae81612d36565b610bed576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610be490615b53565b60405180910390fd5b610bf633612d48565b50565b8033610c058282612719565b610c44576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c3b90615ae7565b60405180910390fd5b610c4d83612d6c565b505050565b6000600354905090565b610c7b3373ffffffffffffffffffffffffffffffffffffffff16613057565b15610cbb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cb290615bbf565b60405180910390fd5b610cc43361224a565b610d03576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cfa90615a0f565b60405180910390fd5b6000349050610d14336000836124e2565b50565b60606000808054905067ffffffffffffffff811115610d3957610d386157a8565b5b604051908082528060200260200182016040528015610d6c57816020015b6060815260200190600190039081610d575790505b50905060005b600080549050811015610f0557610dc660008281548110610d9657610d95615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1661224a565b15610ef25760026000808381548110610de257610de1615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002018054610e5590615c3d565b80601f0160208091040260200160405190810160405280929190818152602001828054610e8190615c3d565b8015610ece5780601f10610ea357610100808354040283529160200191610ece565b820191906000526020600020905b815481529060010190602001808311610eb157829003601f168201915b5050505050828281518110610ee657610ee5615bdf565b5b60200260200101819052505b8080610efd90615c9d565b915050610d72565b508091505090565b6000600854905090565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610fa7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f9e90615d31565b60405180910390fd5b600082829050905060005b81811015610ffd57610fea848483818110610fd057610fcf615bdf565b5b9050602002016020810190610fe591906150c3565b61306a565b8080610ff590615c9d565b915050610fb2565b50505050565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611093576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161108a90615d31565b60405180910390fd5b80600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b670de0b6b3a764000081565b6111023373ffffffffffffffffffffffffffffffffffffffff16613057565b15611142576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161113990615bbf565b60405180910390fd5b8061114c8161224a565b801561115d575061115c816122ab565b5b61119c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611193906159a3565b60405180910390fd5b600033905060003490506111b18483836124e2565b50505050565b606060008060008054905067ffffffffffffffff8111156111db576111da6157a8565b5b6040519080825280602002602001820160405280156112095781602001602082028036833780820191505090505b5090506000805b600080549050811015611315576112646000828154811061123457611233615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166122ab565b15611302576000818154811061127d5761127c615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168383806112b490615c9d565b9450815181106112c7576112c6615bdf565b5b602002602001019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505b808061130d90615c9d565b915050611210565b5081819350935050509091565b3373ffffffffffffffffffffffffffffffffffffffff16600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146113b2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113a990615d9d565b60405180910390fd5b600660006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905033600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a350565b678ac7230489e8000081565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461155a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161155190615e09565b60405180910390fd5b6000600a600087815260200190815260200160002054146115b0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115a790615e4f565b60405180910390fd5b8181905084849050146115f8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115ef90615e4f565b60405180910390fd5b6000805b858590508110156116415785858281811061161a57611619615bdf565b5b905060200201358261162c9190615e6f565b9150808061163990615c9d565b9150506115fc565b50803414611684576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161167b90615eef565b60405180910390fd5b60005b8383905081101561183c5760008484838181106116a7576116a6615bdf565b5b90506020020160208101906116bc91906150c3565b90506116c78161224a565b156118285760006116d7826122ab565b15611702576116ff8888858181106116f2576116f1615bdf565b5b905060200201358361310a565b90505b8088888581811061171657611715615bdf565b5b905060200201356117279190615f0f565b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008282546117789190615e6f565b9250508190555087878481811061179257611791615bdf565b5b90506020020135600a60008b815260200190815260200160002060008282546117bb9190615e6f565b925050819055508787848181106117d5576117d4615bdf565b5b90506020020135600760008282546117ed9190615e6f565b9250508190555087878481811061180757611806615bdf565b5b905060200201356009600082825461181f9190615e6f565b92505081905550505b50808061183490615c9d565b915050611687565b50857e2eb599f04526ff93c5603002bad3a4f97805c8589a52a39c39bad4be38cb85600a600089815260200190815260200160002054858560405161188393929190615fce565b60405180910390a2505050505050565b6000600754905090565b6000600954905090565b336118b18161224a565b80156118c257506118c1816122ab565b5b611901576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016118f8906159a3565b60405180910390fd5b6000339050600b60008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030154841061199b5782600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301819055506119a0565b600080fd5b50505050565b806119b18133613492565b6119f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119e79061604c565b60405180910390fd5b6119fa82336134a6565b5050565b6002602052806000526040600020600091509050806000015490806001015490806002018054611a2d90615c3d565b80601f0160208091040260200160405190810160405280929190818152602001828054611a5990615c3d565b8015611aa65780601f10611a7b57610100808354040283529160200191611aa6565b820191906000526020600020905b815481529060010190602001808311611a8957829003601f168201915b5050505050908060030154908060040154908060050154905086565b33611acc8161224a565b8015611add5750611adc816122ab565b5b611b1c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611b13906159a3565b60405180910390fd5b6000339050600b60008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600301548410611bb65782600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020181905550611bbb565b600080fd5b50505050565b611bca336134fd565b611c09576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c00906160b8565b60405180910390fd5b6000339050611c178161355e565b611c56576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c4d90616124565b60405180910390fd5b6000349050611c64826135fd565b611c70826000836124e2565b611c79826137c4565b5050565b611c85614f95565b81611c8f8161224a565b8015611ca05750611c9f816122ab565b5b611cdf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611cd6906159a3565b60405180910390fd5b600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206040518060a00160405290816000820154815260200160018201548152602001600282015481526020016003820154815260200160048201805480602002602001604051908101604052809291908181526020018280548015611dd657602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311611d8c575b505050505081525050915050919050565b6000600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001015411611e6c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611e6390616190565b60405180910390fd5b611e74613864565b565b60606000805480602002602001604051908101604052809291908181526020018280548015611efa57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311611eb0575b5050505050905090565b80600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002019081611f53919061635c565b503373ffffffffffffffffffffffffffffffffffffffff167f472da4d064218fa97032725fbcff922201fa643fed0765b5ffe0ceef63d7b3dc82604051611f9a919061642e565b60405180910390a250565b606081611fb18161224a565b8015611fc25750611fc1816122ab565b5b612001576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ff8906159a3565b60405180910390fd5b600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206004018054806020026020016040519081016040528092919081815260200182805480156120c357602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311612079575b5050505050915050919050565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614612160576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161215790615d31565b60405180910390fd5b80600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff16600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f38d16b8cac22d99fc7c124b9cd0de2d3fa1faef420bfe791d8c362d765e2270060405160405180910390a350565b6000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000600260038111156122605761225f616450565b5b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030154149050919050565b6000600260038111156122c1576122c0616450565b5b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060050154149050919050565b60006123173361224a565b612356576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161234d90615a0f565b60405180910390fd5b61235f836122ab565b1561239f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612396906164cb565b60405180910390fd5b6802b5e3af16b1880000600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154836123f79190615e6f565b1015612438576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161242f90616537565b60405180910390fd5b6001905092915050565b6002600381111561245657612455616450565b5b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600501819055508073ffffffffffffffffffffffffffffffffffffffff167fa9bd6114e87ea3bd541dd988049a0ba3bc28638c9fbbe88477411de97666194d60405160405180910390a250565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036125745780600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546125689190615e6f565b925050819055506126ab565b61257e8382613a06565b156126a55761258d8383613b0d565b1580156125a1575061259f8383613c06565b155b156125b1576125b08383613cff565b5b80600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546126039190615e6f565b9250508190555080600c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546126999190615e6f565b925050819055506126aa565b600080fd5b5b80600360008282546126bd9190615e6f565b925050819055508273ffffffffffffffffffffffffffffffffffffffff167f5dac0c1b1112564a045ba943c9d50270893e8e826c49be8e7073adc713ab7bd7838360405161270c929190616557565b60405180910390a2505050565b6000826127258161224a565b80156127365750612735816122ab565b5b612775576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161276c906159a3565b60405180910390fd5b6000600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154118061288257506000600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154115b156128905760019150612895565b600091505b5092915050565b60003390506000600c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154905080670de0b6b3a76400008461293a9190615e6f565b111561297b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612972906165cc565b60405180910390fd5b82600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254612a0a9190615f0f565b9250508190555082600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254612a639190615f0f565b925050819055508260036000828254612a7c9190615f0f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc849081150290604051600060405180830381858888f19350505050158015612ac9573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167f1fe665070598cad3c4cc651126f3f92b7b48ae461c589b6f8999bac076befd3f84604051612b10919061504a565b60405180910390a250505050565b60003390506000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001549050612b73826122ab565b15612bd35780670de0b6b3a764000084612b8d9190615e6f565b1115612bce576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612bc5906165cc565b60405180910390fd5b612c2a565b80678ac7230489e8000084612be89190615e6f565b1115612c29576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612c20906165cc565b60405180910390fd5b5b82600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000016000828254612c7c9190615f0f565b925050819055508260036000828254612c959190615f0f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc849081150290604051600060405180830381858888f19350505050158015612ce2573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167f1fe665070598cad3c4cc651126f3f92b7b48ae461c589b6f8999bac076befd3f84604051612d29919061504a565b60405180910390a2505050565b6000612d418261224a565b9050919050565b612d5181613e6c565b612d5a816122ab565b15612d6957612d688161404a565b5b50565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603612ddb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612dd290616638565b60405180910390fd5b6000339050612dea8282613c06565b612e29576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612e20906166a4565b60405180910390fd5b6000600c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001015490506000600c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001018190555080600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001016000828254612f849190615f0f565b925050819055508060076000828254612f9d9190615f0f565b925050819055508060086000828254612fb69190615e6f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015613003573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167fbc84835063c693975166f00cffb19f01a94c2db55b1bf259238c5da3594e50668260405161304a919061504a565b60405180910390a2505050565b600080823b905060008111915050919050565b6002600381111561307e5761307d616450565b5b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401819055508073ffffffffffffffffffffffffffffffffffffffff167fa850ae9193f515cbae8d35e8925bd2be26627fc91bce650b8652ed254e9cab0360405160405180910390a250565b600080600090506000600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001546131a39190615e6f565b9050600081146134875760005b600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040180549050811015613485576000600b60008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401828154811061325357613252615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050600060648461328f91906166c4565b600b60008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154600c60008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001548a61335d91906166c4565b61336791906166c4565b6133719190616735565b905080600c60008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008282546134029190615e6f565b9250508190555080600b60008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600082825461345b9190615e6f565b92505081905550808561346e9190615e6f565b94505050808061347d90615c9d565b9150506131b0565b505b819250505092915050565b600061349e8383613b0d565b905092915050565b6134b08282613b0d565b6134ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016134e6906167b2565b60405180910390fd5b6134f982826145d4565b5050565b60006002600381111561351357613512616450565b5b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040154149050919050565b60006135698261224a565b156135a9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016135a09061681e565b60405180910390fd5b678ac7230489e800003410156135f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016135eb90616537565b60405180910390fd5b60019050919050565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090506002600381111561365457613653616450565b5b816004015414613699576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161369090615e4f565b60405180910390fd5b600260038111156136ad576136ac616450565b5b8160030181905550600160038111156136c9576136c8616450565b5b8160050181905550600080549050600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000829080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff167fd09501348473474a20c772c79c653e1fd7e8b437e418fe235d277d2c8885325160405160405180910390a25050565b600160038111156137d8576137d7616450565b5b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401819055508073ffffffffffffffffffffffffffffffffffffffff167fcdd2e9b91a56913d370075169cefa1602ba36be5301664f752192bb1709df75760405160405180910390a250565b60003390506000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101549050600081116138f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016138ea906166a4565b60405180910390fd5b6000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010181905550806007600082825461394d9190615f0f565b9250508190555080600860008282546139669190615e6f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156139b3573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167fbc84835063c693975166f00cffb19f01a94c2db55b1bf259238c5da3594e5066826040516139fa919061504a565b60405180910390a25050565b600082613a128161224a565b8015613a235750613a22816122ab565b5b613a62576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401613a59906159a3565b60405180910390fd5b600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015483600b60008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154613af39190615e6f565b11613b015760019150613b06565b600091505b5092915050565b600082613b198161224a565b8015613b2a5750613b29816122ab565b5b613b69576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401613b60906159a3565b60405180910390fd5b6000600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001541115613bfa5760019150613bff565b600091505b5092915050565b600082613c128161224a565b8015613c235750613c22816122ab565b5b613c62576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401613c59906159a3565b60405180910390fd5b6000600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101541115613cf35760019150613cf8565b600091505b5092915050565b600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040180549050600d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401819080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015490506000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055508060036000828254613f0d9190615f0f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015613f5a573d6000803e3d6000fd5b508173ffffffffffffffffffffffffffffffffffffffff167fd8654fcc8cf5b36d30b3f5e4688fc78118e6d68de60b9994e09902268b57c3e3600083604051613fa4929190616557565b60405180910390a260016003811115613fc057613fbf616450565b5b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003018190555061400f826147eb565b7f23d934bfe7f1275bc6fd70432159c9cc1c0075d069f89da6a40f43bfe7a94ed38260405161403e919061592b565b60405180910390a15050565b60005b600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401805490508110156144db576000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040182815481106140f0576140ef615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690506000600c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000015490506000600c60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101549050600081836142339190615e6f565b905082600b60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546142879190615f0f565b9250508190555081600b60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160008282546142e09190615f0f565b9250508190555081600760008282546142f99190615f0f565b9250508190555081600860008282546143129190615e6f565b925050819055506000600c60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001819055506000600c60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001018190555061442d8685614a48565b8373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015614473573d6000803e3d6000fd5b508573ffffffffffffffffffffffffffffffffffffffff167fd8654fcc8cf5b36d30b3f5e4688fc78118e6d68de60b9994e09902268b57c3e385836040516144bc929190616557565b60405180910390a25050505080806144d390615c9d565b91505061404d565b506000600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154905080600360008282546145359190615f0f565b925050819055506000600b60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555061458d82614edb565b8173ffffffffffffffffffffffffffffffffffffffff167fdaa735b86a2abee81b17fab8c202f9d71d3124a91b08377f3a9c81c0eb8087c160405160405180910390a25050565b6000600c60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154905080600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160008282546146aa9190615f0f565b925050819055506000600c60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555080600360008282546147489190615f0f565b925050819055508173ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015614795573d6000803e3d6000fd5b508273ffffffffffffffffffffffffffffffffffffffff167fd8654fcc8cf5b36d30b3f5e4688fc78118e6d68de60b9994e09902268b57c3e383836040516147de929190616557565b60405180910390a2505050565b600080549050600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410614871576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161486890615e4f565b60405180910390fd5b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050600060016000805490506148c99190615f0f565b90508082146149b75760008082815481106148e7576148e6615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050806000848154811061492957614928615bdf565b5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b6000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000805480614a0e57614a0d61683e565b5b6001900381819060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690559055505050565b600b60008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040180549050600d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410614b4b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401614b4290615e4f565b60405180910390fd5b6000600d60008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905060006001600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060040180549050614c209190615f0f565b9050808214614dcc576000600b60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206004018281548110614c7f57614c7e615bdf565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905080600b60008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206004018481548110614d0157614d00615bdf565b5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600d60008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b6000600d60008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550600b60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600401805480614ea057614e9f61683e565b5b6001900381819060005260206000200160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055905550505050565b60016003811115614eef57614eee616450565b5b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600501819055508073ffffffffffffffffffffffffffffffffffffffff167fdaa735b86a2abee81b17fab8c202f9d71d3124a91b08377f3a9c81c0eb8087c160405160405180910390a250565b604051806040016040528060008152602001600081525090565b6040518060a0016040528060008152602001600081526020016000815260200160008152602001606081525090565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b614feb81614fd8565b8114614ff657600080fd5b50565b60008135905061500881614fe2565b92915050565b60006020828403121561502457615023614fce565b5b600061503284828501614ff9565b91505092915050565b61504481614fd8565b82525050565b600060208201905061505f600083018461503b565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061509082615065565b9050919050565b6150a081615085565b81146150ab57600080fd5b50565b6000813590506150bd81615097565b92915050565b6000602082840312156150d9576150d8614fce565b5b60006150e7848285016150ae565b91505092915050565b6150f981614fd8565b82525050565b60408201600082015161511560008501826150f0565b50602082015161512860208501826150f0565b50505050565b600060408201905061514360008301846150ff565b92915050565b600080604083850312156151605761515f614fce565b5b600061516e85828601614ff9565b925050602061517f85828601614ff9565b9150509250929050565b600080604083850312156151a05761519f614fce565b5b60006151ae858286016150ae565b92505060206151bf85828601614ff9565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561522f578082015181840152602081019050615214565b60008484015250505050565b6000601f19601f8301169050919050565b6000615257826151f5565b6152618185615200565b9350615271818560208601615211565b61527a8161523b565b840191505092915050565b6000615291838361524c565b905092915050565b6000602082019050919050565b60006152b1826151c9565b6152bb81856151d4565b9350836020820285016152cd856151e5565b8060005b8581101561530957848403895281516152ea8582615285565b94506152f583615299565b925060208a019950506001810190506152d1565b50829750879550505050505092915050565b6000602082019050818103600083015261533581846152a6565b905092915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126153625761536161533d565b5b8235905067ffffffffffffffff81111561537f5761537e615342565b5b60208301915083602082028301111561539b5761539a615347565b5b9250929050565b600080602083850312156153b9576153b8614fce565b5b600083013567ffffffffffffffff8111156153d7576153d6614fd3565b5b6153e38582860161534c565b92509250509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61542481615085565b82525050565b6000615436838361541b565b60208301905092915050565b6000602082019050919050565b600061545a826153ef565b61546481856153fa565b935061546f8361540b565b8060005b838110156154a0578151615487888261542a565b975061549283615442565b925050600181019050615473565b5085935050505092915050565b600060408201905081810360008301526154c7818561544f565b90506154d6602083018461503b565b9392505050565b60008083601f8401126154f3576154f261533d565b5b8235905067ffffffffffffffff8111156155105761550f615342565b5b60208301915083602082028301111561552c5761552b615347565b5b9250929050565b60008060008060006060868803121561554f5761554e614fce565b5b600061555d88828901614ff9565b955050602086013567ffffffffffffffff81111561557e5761557d614fd3565b5b61558a888289016154dd565b9450945050604086013567ffffffffffffffff8111156155ad576155ac614fd3565b5b6155b98882890161534c565b92509250509295509295909350565b600082825260208201905092915050565b60006155e4826151f5565b6155ee81856155c8565b93506155fe818560208601615211565b6156078161523b565b840191505092915050565b600060c082019050615627600083018961503b565b615634602083018861503b565b818103604083015261564681876155d9565b9050615655606083018661503b565b615662608083018561503b565b61566f60a083018461503b565b979650505050505050565b600082825260208201905092915050565b6000615696826153ef565b6156a0818561567a565b93506156ab8361540b565b8060005b838110156156dc5781516156c3888261542a565b97506156ce83615442565b9250506001810190506156af565b5085935050505092915050565b600060a08301600083015161570160008601826150f0565b50602083015161571460208601826150f0565b50604083015161572760408601826150f0565b50606083015161573a60608601826150f0565b5060808301518482036080860152615752828261568b565b9150508091505092915050565b6000602082019050818103600083015261577981846156e9565b905092915050565b6000602082019050818103600083015261579b818461544f565b905092915050565b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6157e08261523b565b810181811067ffffffffffffffff821117156157ff576157fe6157a8565b5b80604052505050565b6000615812614fc4565b905061581e82826157d7565b919050565b600067ffffffffffffffff82111561583e5761583d6157a8565b5b6158478261523b565b9050602081019050919050565b82818337600083830152505050565b600061587661587184615823565b615808565b905082815260208101848484011115615892576158916157a3565b5b61589d848285615854565b509392505050565b600082601f8301126158ba576158b961533d565b5b81356158ca848260208601615863565b91505092915050565b6000602082840312156158e9576158e8614fce565b5b600082013567ffffffffffffffff81111561590757615906614fd3565b5b615913848285016158a5565b91505092915050565b61592581615085565b82525050565b6000602082019050615940600083018461591c565b92915050565b600082825260208201905092915050565b7f4f6e6c792064656c656761746565000000000000000000000000000000000000600082015250565b600061598d600e83615946565b915061599882615957565b602082019050919050565b600060208201905081810360008301526159bc81615980565b9050919050565b7f4f6e6c792076616c696461746f72000000000000000000000000000000000000600082015250565b60006159f9600e83615946565b9150615a04826159c3565b602082019050919050565b60006020820190508181036000830152615a28816159ec565b9050919050565b7f63616e6e6f742062652064656c65676174656500000000000000000000000000600082015250565b6000615a65601383615946565b9150615a7082615a2f565b602082019050919050565b60006020820190508181036000830152615a9481615a58565b9050919050565b7f4f6e6c792064656c656761746f72000000000000000000000000000000000000600082015250565b6000615ad1600e83615946565b9150615adc82615a9b565b602082019050919050565b60006020820190508181036000830152615b0081615ac4565b9050919050565b7f4f6e6c79207374616b6572000000000000000000000000000000000000000000600082015250565b6000615b3d600b83615946565b9150615b4882615b07565b602082019050919050565b60006020820190508181036000830152615b6c81615b30565b9050919050565b7f4f6e6c7920454f41000000000000000000000000000000000000000000000000600082015250565b6000615ba9600883615946565b9150615bb482615b73565b602082019050919050565b60006020820190508181036000830152615bd881615b9c565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680615c5557607f821691505b602082108103615c6857615c67615c0e565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000615ca882614fd8565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203615cda57615cd9615c6e565b5b600182019050919050565b7f4f6e6c79206f776e657200000000000000000000000000000000000000000000600082015250565b6000615d1b600a83615946565b9150615d2682615ce5565b602082019050919050565b60006020820190508181036000830152615d4a81615d0e565b9050919050565b7f6e6f7420746865206e6577206f776e6572000000000000000000000000000000600082015250565b6000615d87601183615946565b9150615d9282615d51565b602082019050919050565b60006020820190508181036000830152615db681615d7a565b9050919050565b7f4f6e6c79207265776172642057616c6c65740000000000000000000000000000600082015250565b6000615df3601283615946565b9150615dfe82615dbd565b602082019050919050565b60006020820190508181036000830152615e2281615de6565b9050919050565b50565b6000615e39600083615946565b9150615e4482615e29565b600082019050919050565b60006020820190508181036000830152615e6881615e2c565b9050919050565b6000615e7a82614fd8565b9150615e8583614fd8565b9250828201905080821115615e9d57615e9c615c6e565b5b92915050565b7f6e6f7420656e6f7567682076616c756500000000000000000000000000000000600082015250565b6000615ed9601083615946565b9150615ee482615ea3565b602082019050919050565b60006020820190508181036000830152615f0881615ecc565b9050919050565b6000615f1a82614fd8565b9150615f2583614fd8565b9250828203905081811115615f3d57615f3c615c6e565b5b92915050565b6000819050919050565b6000615f5c60208401846150ae565b905092915050565b6000602082019050919050565b6000615f7d83856153fa565b9350615f8882615f43565b8060005b85811015615fc157615f9e8284615f4d565b615fa8888261542a565b9750615fb383615f64565b925050600181019050615f8c565b5085925050509392505050565b6000604082019050615fe3600083018661503b565b8181036020830152615ff6818486615f71565b9050949350505050565b7f4f6e6c792064656c656761746f72207374616b65720000000000000000000000600082015250565b6000616036601583615946565b915061604182616000565b602082019050919050565b6000602082019050818103600083015261606581616029565b9050919050565b7f4f6e6c792077686974656c697374000000000000000000000000000000000000600082015250565b60006160a2600e83615946565b91506160ad8261606c565b602082019050919050565b600060208201905081810360008301526160d181616095565b9050919050565b7f63616e6e6f742062652076616c696461746f7200000000000000000000000000600082015250565b600061610e601383615946565b9150616119826160d8565b602082019050919050565b6000602082019050818103600083015261613d81616101565b9050919050565b7f4f6e6c7920726577617264657200000000000000000000000000000000000000600082015250565b600061617a600d83615946565b915061618582616144565b602082019050919050565b600060208201905081810360008301526161a98161616d565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026162127fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826161d5565b61621c86836161d5565b95508019841693508086168417925050509392505050565b6000819050919050565b600061625961625461624f84614fd8565b616234565b614fd8565b9050919050565b6000819050919050565b6162738361623e565b61628761627f82616260565b8484546161e2565b825550505050565b600090565b61629c61628f565b6162a781848461626a565b505050565b5b818110156162cb576162c0600082616294565b6001810190506162ad565b5050565b601f821115616310576162e1816161b0565b6162ea846161c5565b810160208510156162f9578190505b61630d616305856161c5565b8301826162ac565b50505b505050565b600082821c905092915050565b600061633360001984600802616315565b1980831691505092915050565b600061634c8383616322565b9150826002028217905092915050565b616365826151f5565b67ffffffffffffffff81111561637e5761637d6157a8565b5b6163888254615c3d565b6163938282856162cf565b600060209050601f8311600181146163c657600084156163b4578287015190505b6163be8582616340565b865550616426565b601f1984166163d4866161b0565b60005b828110156163fc578489015182556001820191506020850194506020810190506163d7565b868310156164195784890151616415601f891682616322565b8355505b6001600288020188555050505b505050505050565b6000602082019050818103600083015261644881846155d9565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b7f616c726561647920612064656c65676174656500000000000000000000000000600082015250565b60006164b5601383615946565b91506164c08261647f565b602082019050919050565b600060208201905081810360008301526164e4816164a8565b9050919050565b7f6e6f74206d656574206d696e696d756d207374616b6500000000000000000000600082015250565b6000616521601683615946565b915061652c826164eb565b602082019050919050565b6000602082019050818103600083015261655081616514565b9050919050565b600060408201905061656c600083018561591c565b616579602083018461503b565b9392505050565b7f6f7574206f662072616e67650000000000000000000000000000000000000000600082015250565b60006165b6600c83615946565b91506165c182616580565b602082019050919050565b600060208201905081810360008301526165e5816165a9565b9050919050565b7f496e76616c69642064656c656761746565000000000000000000000000000000600082015250565b6000616622601183615946565b915061662d826165ec565b602082019050919050565b6000602082019050818103600083015261665181616615565b9050919050565b7f4e6f2070656e64696e6720726577617264000000000000000000000000000000600082015250565b600061668e601183615946565b915061669982616658565b602082019050919050565b600060208201905081810360008301526166bd81616681565b9050919050565b60006166cf82614fd8565b91506166da83614fd8565b92508282026166e881614fd8565b915082820484148315176166ff576166fe615c6e565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061674082614fd8565b915061674b83614fd8565b92508261675b5761675a616706565b5b828204905092915050565b7f6e6f74207374616b656400000000000000000000000000000000000000000000600082015250565b600061679c600a83615946565b91506167a782616766565b602082019050919050565b600060208201905081810360008301526167cb8161678f565b9050919050565b7f616c726561647920612076616c696461746f7200000000000000000000000000600082015250565b6000616808601383615946565b9150616813826167d2565b602082019050919050565b60006020820190508181036000830152616837816167fb565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603160045260246000fdfea26469706673582212209dea7be62e1145cc34b3045992686a67946405cefce76ee639d365d70c14247e64736f6c63430008130033"
)

// PredeployStakingSC is a helper method for setting up the staking smart contract account,
// using the passed in validators as pre-staked validators
func PredeployStakingSC(
	vals validators.Validators,
	params PredeployParams,
) (*chain.GenesisAccount, error) {
	// Set the code for the staking smart contract
	scHex, _ := hex.DecodeHex(StakingSCBytecode)
	stakingAccount := &chain.GenesisAccount{
		Code: scHex,
	}

	// Parse the default staked balance value into *big.Int
	val := DefaultStakedBalance
	bigDefaultStakedBalance, err := types.ParseUint256orHex(&val)
	if err != nil {
		return nil, fmt.Errorf("unable to generate DefaultStatkedBalance, %w", err)
	}

	// Generate the empty account storage map
	storageMap := make(map[types.Hash]types.Hash)
	bigTrueValue := big.NewInt(2)
	bigFalseValue := big.NewInt(1)
	stakedAmount := big.NewInt(0)
	rewardWallet := params.RewardWallet
	// baseReward := big.NewInt(int64(params.BaseReward))
	owner := params.Owner
	valsLen := big.NewInt(0)

	if vals != nil {
		valsLen = big.NewInt(int64(vals.Len()))

		for idx := 0; idx < vals.Len(); idx++ {
			validator := vals.At(uint64(idx))

			idxStakedBalance := new(big.Int).Mul(new(big.Int).SetUint64(uint64(idx+1)), bigDefaultStakedBalance)
			// Update the total staked amount
			stakedAmount = stakedAmount.Add(stakedAmount, idxStakedBalance)

			// Get the storage indexes
			storageIndexes := getStorageIndexes(validator, idx)

			// Set the value for the validators array
			storageMap[types.BytesToHash(storageIndexes.ValidatorsIndex)] =
				types.BytesToHash(
					validator.Addr().Bytes(),
				)

			// Set the value for the address -> validator index mapping
			storageMap[types.BytesToHash(storageIndexes.AddressToValidatorIndexIndex)] =
				types.StringToHash(hex.EncodeUint64(uint64(idx)))

			// Set the value for the address -> Validator.Stake mapping
			storageMap[types.BytesToHash(storageIndexes.ValidatorStakeIndex)] =
				types.BytesToHash(idxStakedBalance.Bytes())

			// Set the value for the address -> Validator.Stake mapping
			storageMap[types.BytesToHash(storageIndexes.ValidatorRewardIndex)] =
				types.BytesToHash(idxStakedBalance.Bytes())

			// Set the value for the address -> Validator.IsActive mapping
			storageMap[types.BytesToHash(storageIndexes.ValidatorIsActiveIndex)] =
				types.BytesToHash(bigTrueValue.Bytes())

			// Set the value for the address -> Validator.IsWhitelisted mapping
			storageMap[types.BytesToHash(storageIndexes.ValidatorIsWhitelistedIndex)] =
				types.BytesToHash(bigFalseValue.Bytes())

			// Set the value for the address -> Validator.blsKey
			if blsValidator, ok := validator.(*validators.BLSValidator); ok {
				setBytesToStorage(
					storageMap,
					storageIndexes.ValidatorBlsKeyIndex,
					blsValidator.BLSPublicKey,
				)
			}
		}
	}

	// Set the value for the total staked amount
	storageMap[types.BytesToHash(big.NewInt(stakedAmountSlot).Bytes())] =
		types.BytesToHash(stakedAmount.Bytes())

	// Set the value for the size of the validators array
	storageMap[types.BytesToHash(big.NewInt(validatorsSlot).Bytes())] =
		types.BytesToHash(valsLen.Bytes())

	// Set the value for the reward wallet
	storageMap[types.BytesToHash(big.NewInt(rewardWalletSlot).Bytes())] =
		types.BytesToHash(rewardWallet[:])

	// Set the value for the owner
	storageMap[types.BytesToHash(big.NewInt(ownerSlot).Bytes())] =
		types.BytesToHash(owner[:])

	// Set the value for the base reward
	// storageMap[types.BytesToHash(big.NewInt(baseRewardSlot).Bytes())] =
	// 	types.BytesToHash(baseReward.Bytes())

	// Save the storage map
	stakingAccount.Storage = storageMap

	// Set the Staking SC balance to numValidators * defaultStakedBalance
	stakingAccount.Balance = stakedAmount

	return stakingAccount, nil
}
